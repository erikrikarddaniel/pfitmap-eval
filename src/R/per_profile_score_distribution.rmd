---
title: "Pfitmap-eval: Distribution of scores per sequence and profile"
author: "daniel.lundin@lnu.se"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 9
    fig_width: 8
    number_sections: yes
    toc: yes
  html_document:
    toc: yes
---

```{r libraries, echo=F}

suppressPackageStartupMessages(library(dplyr));
suppressPackageStartupMessages(library(ggplot2));
suppressPackageStartupMessages(library(kfigr));
suppressPackageStartupMessages(library(knitr));
#suppressPackageStartupMessages(library(readr));
suppressPackageStartupMessages(library(tidyr));

```

```{r constants, echo=F}

```

```{r functions, echo=F}

```

```{r db-connect, echo=F}

db = src_postgres('pfitmap-eval-prod')

```

# Hierarchies with family results
 
```{r fscores, echo=F}

fscores = tbl(db, sql("
SELECT 
  fname,
  gi,
  accno,
  name,
  sequence,
  score_pattern,
  fscore,
  cscore,
  scscore
FROM
  fscores
WHERE 
  db = 'gb'
"
    )
  ) %>%
  transmute(
    fname,
    gi,
    accno,
    name,
    sequence,
    pattern=score_pattern, 
    family=fscore, 
    class=cscore, 
    subclass=scscore
  )

fscoresl = gather(collect(fscores), key=rank, value=score, family, class, subclass)

### fscores_summary = tbl(db, sql('select fname, score_pattern, count(*), avg(fscore), avg(cscore), avg(scscore) from fscores group by 1, 2 order by 1,2'))

```

```{r fscores-hist, echo=F}

ggplot(fscoresl, aes(x=score, fill=pattern)) + 
  geom_histogram(position='dodge', binwidth=30) + 
  facet_wrap(~rank, ncol=1) + 
  ylim(c(0,1000))

```


```{r fscores-sum, echo=F}

### kable(
###   fscores %>% 
###     filter(!is.na(family_score)) %>%
###     group_by(family) %>% 
###     summarize(
###       n=n(), 
###       min_family=min(family),
###       mean_family=mean(family),
###       max_family=max(family),
###       min_class=min(class),
###       mean_class=mean(class),
###       max_class=max(class),
###       min_subclass=min(subclass),
###       mean_subclass=mean(subclass),
###       max_subclass=max(subclass)
###     ) %>%
###     arrange(family),
###   col.names = c('Family', 'N.', 'Min', 'Fmean', 'Max', 'Min', 'Classmean', 'Max', 'Min', 'SBmean', 'Max')
### )

```
